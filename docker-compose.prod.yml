# Production compose for Learning Finnish on VPS
# Database: PostgreSQL on homelab (dobbybrain:5433) via Tailscale
# No local db service - backend connects to homelab over Tailscale

version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VITE_BASE_PATH: /finnish/
    container_name: finnish-backend-prod
    restart: unless-stopped
    environment:
      DEBUG: "False"
      DATABASE_URL: ${DATABASE_URL}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      CORS_ORIGINS: '["https://ai-vaerksted.cloud"]'
    expose:
      - "8000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.finnish-backend.rule=Host(`ai-vaerksted.cloud`) && PathPrefix(`/finnish`)"
      - "traefik.http.routers.finnish-backend.entrypoints=websecure"
      - "traefik.http.routers.finnish-backend.tls.certresolver=mytlschallenge"
      - "traefik.http.services.finnish-backend.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.finnish-strip.stripprefix.prefixes=/finnish"
      - "traefik.http.routers.finnish-backend.middlewares=finnish-strip"
    networks:
      - traefik-network

networks:
  traefik-network:
    external: true
    name: traefik-network
